name: CI - Build & Push to Docker Hub

on:
  push:
    branches:
      - main
    paths:
      - 'src/backtest/**'
      - 'src/news/**'
      - 'src/stocks/**'
      - 'src/ui/**'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backtest: ${{ steps.changes.outputs.backtest }}
      news: ${{ steps.changes.outputs.news }}
      news_scraper: ${{ steps.changes.outputs.news_scraper }}
      stocks: ${{ steps.changes.outputs.stocks }}
      stocks_scraper: ${{ steps.changes.outputs.stocks_scraper }}
      ui: ${{ steps.changes.outputs.ui }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 변경점이 발생한 서비스만 파악
      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            backtest:
              - 'src/backtest/**'
            news:
              - 'src/news/service/**'
            news_scraper:
              - 'src/news/scraper/**'
            stocks:
              - 'src/stocks/app/**'
            stocks_scraper:
              - 'src/stocks/scraper/**'
            ui:
              - 'src/ui/**'

  build-backtest:
    needs: detect-changes
    permissions:
      contents: write
    if: needs.detect-changes.outputs.backtest == 'true'
    uses: ./.github/workflows/build.yml
    with:
      service: backtest

  build-news:
    needs: detect-changes
    permissions:
      contents: write
    if: needs.detect-changes.outputs.news == 'true'
    uses: ./.github/workflows/build.yml
    with:
      service: news

  build-stocks:
    needs: detect-changes
    permissions:
      contents: write
    if: needs.detect-changes.outputs.stocks == 'true'
    uses: ./.github/workflows/build.yml
    with:
      service: stocks

  build-ui:
    needs: detect-changes
    permissions:
      contents: write
    if: needs.detect-changes.outputs.ui == 'true'
    uses: ./.github/workflows/build.yml
    with:
      service: ui

  build-news-scraper:
    needs: detect-changes
    permissions:
      contents: write
    if: needs.detect-changes.outputs.news_scraper == 'true'
    uses: ./.github/workflows/build.yml
    with:
      service: news
      scraper: true

  build-stocks-scraper:
    needs: detect-changes
    permissions:
      contents: write
    if: needs.detect-changes.outputs.stocks_scraper == 'true'
    uses: ./.github/workflows/build.yml
    with:
      service: stocks
      scraper: true
